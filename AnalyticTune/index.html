<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ArduCopter Analytic Tune Tool</title>
<link rel="icon" href="../images/AP_favicon.png">
<script type="text/javascript" src="AnalyticTune.js"></script>
<script type="text/javascript" src="DiscreteFilter.js"></script>
<script type="text/javascript" src="../Libraries/FileSaver.js"></script>
<script type="text/javascript" src="../Libraries/Array_Math.js"></script>
<script type="text/javascript" src="../Libraries/ParameterMetadata.js"></script>
<script type="text/javascript" src="../Libraries/Param_Helpers.js"></script>
<script type="text/javascript" src="../Libraries/Plotly_helpers.js"></script>
<script type="text/javascript" src="../Libraries/fft.js"></script>
<script type="text/javascript" src="../Libraries/OpenIn.js"></script>
<script type="text/javascript" src="../Libraries/LoadingOverlay.js"></script>
<script type="text/javascript" src="../Libraries/Plotly_helpers.js"></script>
<script type="text/javascript" src="../Libraries/LogHelpers.js"></script>

<script src="../modules/build/floating-ui/dist/umd/popper.min.js"></script>
<script src="../modules/build/tippyjs/dist/tippy-bundle.umd.min.js"></script>
<script src='../modules/plotly.js/dist/plotly.min.js'></script>
<script src='../modules/fft.js/dist/fft.js'></script>
</head>
<table style="width:1200px"><tr><td>
    <a href="https://ardupilot.org"><img src="../images/ArduPilot.png"></a>
</td><td>
    <a href="https://github.com/ArduPilot/WebTools"><img src="../images/github-mark.png" style="width:60px"></a>
    <br>
    <a href="https://github.com/ArduPilot/WebTools"><img src="../images/GitHub_Logo.png" style="width:60px"></a>
</td></tr></table>

<style>
        div.plotly-notifier {
                visibility: hidden;
        }
</style>

<h1><a href="" style="color: #000000; text-decoration:none;">ArduCopter Analytic Tune Tool</a></h1>

<body onload="setup_time_history_plots();">

<table>
        <tr>
        <td style="width: 30px;"></td>
        <td>
        <fieldset style="width:1100px">
                <legend>Setup</legend>
                <table>
                <tr>
                <td>
                        <fieldset style="width:200px;height:80px">
                        <legend>FFT Settings</legend>
                        <table>
                                <td style="width: 125px;">
                                <label for="FFTWindow_size">Window size</label>
                                </td>
                                <td>
                                <input id="FFTWindow_size" name="FFTWindow_size" type="number" min="1" step="1" value="1024" onchange="window_size_inc(event)" style="width:50px"/>
                                </td>
                        </table>
                        </fieldset>
                </td>
                <td>
                <fieldset style="width:200px;height:80px">
                        <legend>Analysis time</legend>
                        <label for="starttime">Start (s)</label>
                        <input id="starttime" type="number" min="0" step="1" value="0" onchange="time_range_changed()" style="width:100px"/><br><br>
                        <label for="endtime">End (s)</label>
                        <input id="endtime" type="number" min="0" step="1" value="0" onchange="time_range_changed()" style="width:100px"/>
                </fieldset>
                </td>
                <td style="width: 10px;"></td>
                <td>
                <input id="fileItem" type="file" accept=".bin" onchange="readFile(this)"><br><br>
                </td>
                </tr>
                </table>
        </fieldset>
        </td>
        </tr>
</table>
<table>
<tr>
        <td style="width: 30px;"></td>
        <td>
                <fieldset style="width:600px; min-height:300px" id="sid_sets">
                    <legend>System ID Runs</legend>
                </fieldset>
        </td>
        </tr>

</table>


<table><tr><td style="width:1200px">
<h2 style="text-align:center">Flight Data</h2>
</td></tr></table>

<div id="FlightData" style="width:1200px;height:450px"></div>

<p>
  <input type="button" id="calculate" value="Calculate">
  <input type="button" id="SaveParams" value="Save Parameters" onclick="save_parameters();">
  <button class="styleClass" onclick="document.getElementById('param_file').click()">Load Parameters</button>
  <input type='file' id="param_file" style="display:none" onchange="load_parameters(this.files[0]);">
</p>

<!-- Container for dynamically generated content -->
<div id="dynamic-content-container"></div>


<script>
// =====================================================================================
// DATA STRUCTURE FOR DYNAMIC PAGE GENERATION
// =====================================================================================
const pageSections = [
    {
        type: 'heading',
        level: 2,
        content: {
            tag: 'label',
            id: 'warning',
            text: 'WARNING - Parameter values are not updated if they changed during the log. If parameters were changed during the flight, be sure to verify the values below.'
        }
    },
    {
        type: 'form',
        id: 'params',
        action: '',
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'Loop Rate',
                elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'SCHED_LOOP_RATE', name: 'SCHED_LOOP_RATE', type: 'number', step: '1', value: '400', 'data-paramValues': 'false' } ] }
                ]
            }
        ]
    }
];

const pageSections_param_notch_mode = [
    {
        type: 'form',
        id: 'params',
        isFragment: true,
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'INS Settings',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'GyroSampleRate', text: 'Gyro Sample Rate' }, { tag: 'input', id: 'GyroSampleRate', name: 'GyroSampleRate', type: 'number', step: '1', value: '2000' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'INS_GYRO_FILTER', name: 'INS_GYRO_FILTER', type: 'number', step: '0.1', value: '20.0', style: 'width: 100px' } ] }
                ]
            },
            {
                type: 'table',
                content: [
                    {
                        type: 'tr',
                        id: 'INS-settings-row',
                        content: [
                           {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'First Notch Filter',
                                    elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_ENABLE', name: 'INS_HNTCH_ENABLE', type: 'number', step: '1', value: '1', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_MODE', name: 'INS_HNTCH_MODE', type: 'number', step: '1', value: '1', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_FREQ', name: 'INS_HNTCH_FREQ', type: 'number', step: '0.1', value: '150', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_BW', name: 'INS_HNTCH_BW', type: 'number', step: '0.1', value: '75', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_ATT', name: 'INS_HNTCH_ATT', type: 'number', step: '0.1', value: '40', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_REF', name: 'INS_HNTCH_REF', type: 'number', step: '0.01', value: '0.29', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_FM_RAT', name: 'INS_HNTCH_FM_RAT', type: 'number', step: '0.01', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_HMNCS', name: 'INS_HNTCH_HMNCS', type: 'number', step: '1', value: '3', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_OPTS', name: 'INS_HNTCH_OPTS', type: 'number', step: '1', value: '0', style: 'width: 100px' } ] }
                                    ]
                                }
                           },
                           {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'Second Notch Filter',
                                    elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_ENABLE', name: 'INS_HNTC2_ENABLE', type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_MODE', name: 'INS_HNTC2_MODE', type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_FREQ', name: 'INS_HNTC2_FREQ', type: 'number', step: '0.1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_BW', name: 'INS_HNTC2_BW', type: 'number', step: '0.1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_ATT', name: 'INS_HNTC2_ATT', type: 'number', step: '0.1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_REF', name: 'INS_HNTC2_REF', type: 'number', step: '0.01', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_FM_RAT', name: 'INS_HNTC2_FM_RAT', type: 'number', step: '0.01', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_HMNCS', name: 'INS_HNTC2_HMNCS', type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_OPTS', name: 'INS_HNTC2_OPTS', type: 'number', step: '1', value: '0', style: 'width: 100px' } ] }
                                    ]
                                }
                           }
                        ]
                    }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'Throttle_input',
                legend: 'Throttle Based',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'Throttle', text: 'Throttle' }, { tag: 'input', id: 'Throttle', name: 'Throttle', type: 'number', step: '0.01', value: '0.3' } ] }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'ESC_input',
                legend: 'ESC Telemetry',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'NUM_MOTORS', text: 'Number of Motors' }, { tag: 'input', id: 'NUM_MOTORS', name: 'NUM_MOTORS', type: 'number', step: '1', value: '1' } ] },
                    { type: 'p', content: [ { tag: 'label', for: 'ESC_RPM', text: 'ESC RPM' }, { tag: 'input', id: 'ESC_RPM', name: 'ESC_RPM', type: 'number', step: '1', value: '2500' } ] }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'RPM_input',
                legend: 'RPM/EFI Based',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'RPM1', text: 'RPM1' }, { tag: 'input', id: 'RPM1', name: 'RPM1', type: 'number', step: '1', value: '2500' } ] },
                    { type: 'p', content: [ { tag: 'label', for: 'RPM2', text: 'RPM2' }, { tag: 'input', id: 'RPM2', name: 'RPM2', type: 'number', step: '1', value: '2500' } ] }
                ]
            }
        ]
    }
];

const pageSections_param_RW = [
    {
        type: 'form',
        id: 'params',
        isFragment: true,
        content: [
            {
                type: 'table',
                content: [
                    {
                        type: 'tr',
                        id: 'attitude-controller-row',
                        content: [
                            {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'Attitude Controller Parameters',
                                    groups: [
                                        { divId: 'RollPitchTC', style: 'display:block', elements: [ { type: 'p', content: [ { tag: 'input', id: 'ATC_INPUT_TC', name: 'ATC_INPUT_TC', type: 'number', step: '0.01', value: '0.15' } ] } ] },
                                        { divId: 'YawTC', style: 'display:None', elements: [ { type: 'p', content: [ { tag: 'input', id: 'PILOT_Y_RATE_TC', name: 'PILOT_Y_RATE_TC', type: 'number', step: '0.01', value: '0.0' } ] } ] },
                                        { divId: 'RollPIDS', style: 'display:block', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_RLL_P', name: 'ATC_ANG_RLL_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FF', name: 'ATC_RAT_RLL_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_P', name: 'ATC_RAT_RLL_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_I', name: 'ATC_RAT_RLL_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_D', name: 'ATC_RAT_RLL_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_D_FF', name: 'ATC_RAT_RLL_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTT', name: 'ATC_RAT_RLL_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTE', name: 'ATC_RAT_RLL_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTD', name: 'ATC_RAT_RLL_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'PitchPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_PIT_P', name: 'ATC_ANG_PIT_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FF', name: 'ATC_RAT_PIT_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_P', name: 'ATC_RAT_PIT_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_I', name: 'ATC_RAT_PIT_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_D', name: 'ATC_RAT_PIT_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_D_FF', name: 'ATC_RAT_PIT_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTT', name: 'ATC_RAT_PIT_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTE', name: 'ATC_RAT_PIT_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTD', name: 'ATC_RAT_PIT_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'YawPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_YAW_P', name: 'ATC_ANG_YAW_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FF', name: 'ATC_RAT_YAW_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_P', name: 'ATC_RAT_YAW_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_I', name: 'ATC_RAT_YAW_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_D', name: 'ATC_RAT_YAW_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_D_FF', name: 'ATC_RAT_YAW_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTT', name: 'ATC_RAT_YAW_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTE', name: 'ATC_RAT_YAW_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTD', name: 'ATC_RAT_YAW_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]}
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_param_QP = [
    {
        type: 'form',
        id: 'params',
        isFragment: true,
        content: [
            {
                type: 'table',
                content: [
                    {
                        type: 'tr',
                        id: 'attitude-controller-row',
                        content: [
                            {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'Attitude Controller Parameters',
                                    groups: [
                                        { divId: 'RollPitchTC', style: 'display:none', elements: [ { type: 'p', content: [ { tag: 'input', id: 'Q_A_INPUT_TC', name: 'Q_A_INPUT_TC', type: 'number', step: '0.01', value: '0.15' } ] } ] },
                                        { divId: 'YawTC', style: 'display:None', elements: [ { type: 'p', content: [ { tag: 'input', id: 'Q_PLT_Y_RATE_TC', name: 'Q_PLT_Y_RATE_TC', type: 'number', step: '0.01', value: '0.0' } ] } ] },
                                        { divId: 'RollPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_RLL_P', name: 'Q_A_ANG_RLL_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FF', name: 'Q_A_RAT_RLL_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_P', name: 'Q_A_RAT_RLL_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_I', name: 'Q_A_RAT_RLL_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_D', name: 'Q_A_RAT_RLL_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_D_FF', name: 'Q_A_RAT_RLL_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTT', name: 'Q_A_RAT_RLL_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTE', name: 'Q_A_RAT_RLL_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTD', name: 'Q_A_RAT_RLL_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'PitchPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_PIT_P', name: 'Q_A_ANG_PIT_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FF', name: 'Q_A_RAT_PIT_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_P', name: 'Q_A_RAT_PIT_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_I', name: 'Q_A_RAT_PIT_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_D', name: 'Q_A_RAT_PIT_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_D_FF', name: 'Q_A_RAT_PIT_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTT', name: 'Q_A_RAT_PIT_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTE', name: 'Q_A_RAT_PIT_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTD', name: 'Q_A_RAT_PIT_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'YawPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_YAW_P', name: 'Q_A_ANG_YAW_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FF', name: 'Q_A_RAT_YAW_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_P', name: 'Q_A_RAT_YAW_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_I', name: 'Q_A_RAT_YAW_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_D', name: 'Q_A_RAT_YAW_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_D_FF', name: 'Q_A_RAT_YAW_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTT', name: 'Q_A_RAT_YAW_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTE', name: 'Q_A_RAT_YAW_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTD', name: 'Q_A_RAT_YAW_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]}
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_param_FW = [
    {
        type: 'form',
        id: 'params',
        isFragment: true,
        content: [
            {
                type: 'table',
                content: [
                    {
                        type: 'tr',
                        id: 'attitude-controller-row',
                        content: [
                            {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'Attitude Controller Parameters',
                                    groups: [
                                        { divId: 'RollPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL2SRV_TCONST', name: 'RLL2SRV_TCONST', type: 'number', step: '0.01', value: '0.25' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FF', name: 'RLL_RATE_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_P', name: 'RLL_RATE_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_I', name: 'RLL_RATE_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_D', name: 'RLL_RATE_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_D_FF', name: 'RLL_RATE_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTT', name: 'RLL_RATE_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTE', name: 'RLL_RATE_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTD', name: 'RLL_RATE_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'PitchPIDS', style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH2SRV_TCONST', name: 'PTCH2SRV_TCONST', type: 'number', step: '0.01', value: '0.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FF', name: 'PTCH_RATE_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_P', name: 'PTCH_RATE_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_I', name: 'PTCH_RATE_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_D', name: 'PTCH_RATE_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_D_FF', name: 'PTCH_RATE_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTT', name: 'PTCH_RATE_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTE', name: 'PTCH_RATE_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTD', name: 'PTCH_RATE_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]}
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_param_POS = [
    {
        type: 'form',
        id: 'params',
        isFragment: true,
        content: [
            {
                type: 'table',
                content: [
                    {
                        type: 'tr',
                        id: 'attitude-controller-row',
                        content: [
                            {
                                type: 'td',
                                content: {
                                    type: 'fieldset',
                                    style: 'width:580px',
                                    legend: 'Position Controller Parameters',
                                    groups: [
                                        { divId: 'RollPIDS', style: 'display:block', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_POSXY_P', name: 'PSC_POSXY_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_FF', name: 'PSC_VELXY_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_P', name: 'PSC_VELXY_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_I', name: 'PSC_VELXY_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_D', name: 'PSC_VELXY_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_FLTE', name: 'PSC_VELXY_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELXY_FLTD', name: 'PSC_VELXY_FLTD', type: 'number', step: '0.01', value: '20' } ] }
                                        ]},
                                        { divId: 'PitchPIDS', style: 'display:none', elements: [
/*                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_POSZ_P', name: 'PSC_POSZ_P', type: 'number', step: '0.1', value: '4.5' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_FF', name: 'PSC_VELZ_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_P', name: 'PSC_VELZ_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_I', name: 'PSC_VELZ_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_D', name: 'PSC_VELZ_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_FLTE', name: 'PSC_VELZ_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_VELZ_FLTD', name: 'PSC_VELZ_FLTD', type: 'number', step: '0.01', value: '20' } ] } */
                                        ]},
                                        { divId: 'YawPIDS', style: 'display:none', elements: [
/*                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_FF', name: 'PSC_ACCZ_FF', type: 'number', step: '0.01', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_P', name: 'PSC_ACCZ_P', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_I', name: 'PSC_ACCZ_I', type: 'number', step: '0.01', value: '0.288' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_D', name: 'PSC_ACCZ_D', type: 'number', step: '0.0001', value: '0.0117' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_D_FF', name: 'PSC_ACCZ_D_FF', type: 'number', step: '0.0001', value: '0.0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_FLTT', name: 'PSC_ACCZ_FLTT', type: 'number', step: '0.01', value: '1.77' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_FLTE', name: 'PSC_ACCZ_FLTE', type: 'number', step: '0.01', value: '0' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_FLTD', name: 'PSC_ACCZ_FLTD', type: 'number', step: '0.01', value: '20' } ] }  */
                                        ]}
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_notch_param_RW = [
    {
        type: 'tableCell',
        targetId: 'attitude-controller-row',
        content: {
            type: 'fieldset',
            style: 'width:580px',
            legend: 'Attitude Controller Notch Parameters',
            groups: [
                { divId: 'RollNOTCH', style: 'display:block', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_NTF', name: 'ATC_RAT_RLL_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_NEF', name: 'ATC_RAT_RLL_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'PitchNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_NTF', name: 'ATC_RAT_PIT_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_NEF', name: 'ATC_RAT_PIT_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'YawNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_NTF', name: 'ATC_RAT_YAW_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_NEF', name: 'ATC_RAT_YAW_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                ...[...Array(8).keys()].map(i => ({
                    divId: `FILT${i + 1}`, style: 'display:none', elements: [
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_TYPE`, name: `FILT${i + 1}_TYPE`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_FREQ`, name: `FILT${i + 1}_NOTCH_FREQ`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_Q`, name: `FILT${i + 1}_NOTCH_Q`, type: 'number', step: '0.1', value: '2', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_ATT`, name: `FILT${i + 1}_NOTCH_ATT`, type: 'number', step: '1', value: '40', style: 'width: 100px' } ] }
                    ]
                }))
            ]
        }
    }
];
const pageSections_notch_param_QP = [
    {
        type: 'tableCell',
        targetId: 'attitude-controller-row',
        content: {
            type: 'fieldset',
            style: 'width:580px',
            legend: 'Attitude Controller Notch Parameters',
            groups: [
                { divId: 'QRollNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_NTF', name: 'Q_A_RAT_RLL_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_NEF', name: 'Q_A_RAT_RLL_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'QPitchNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_NTF', name: 'Q_A_RAT_PIT_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_NEF', name: 'Q_A_RAT_PIT_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'QYawNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_NTF', name: 'Q_A_RAT_YAW_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_NEF', name: 'Q_A_RAT_YAW_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                ...[...Array(8).keys()].map(i => ({
                    divId: `FILT${i + 1}`, style: 'display:none', elements: [
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_TYPE`, name: `FILT${i + 1}_TYPE`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_FREQ`, name: `FILT${i + 1}_NOTCH_FREQ`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_Q`, name: `FILT${i + 1}_NOTCH_Q`, type: 'number', step: '0.1', value: '2', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_ATT`, name: `FILT${i + 1}_NOTCH_ATT`, type: 'number', step: '1', value: '40', style: 'width: 100px' } ] }
                    ]
                }))
            ]
        }
    }
];
const pageSections_notch_param_FW = [
    {
        type: 'tableCell',
        targetId: 'attitude-controller-row',
        content: {
            type: 'fieldset',
            style: 'width:580px',
            legend: 'Attitude Controller Notch Parameters',
            groups: [
                { divId: 'FWRollNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_NTF', name: 'RLL_RATE_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_NEF', name: 'RLL_RATE_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'FWPitchNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_NTF', name: 'PTCH_RATE_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_NEF', name: 'PTCH_RATE_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                { divId: 'FWYawNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'YAW_RATE_NTF', name: 'YAW_RATE_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'YAW_RATE_NEF', name: 'YAW_RATE_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                ...[...Array(8).keys()].map(i => ({
                    divId: `FILT${i + 1}`, style: 'display:none', elements: [
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_TYPE`, name: `FILT${i + 1}_TYPE`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_FREQ`, name: `FILT${i + 1}_NOTCH_FREQ`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_Q`, name: `FILT${i + 1}_NOTCH_Q`, type: 'number', step: '0.1', value: '2', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_ATT`, name: `FILT${i + 1}_NOTCH_ATT`, type: 'number', step: '1', value: '40', style: 'width: 100px' } ] }
                    ]
                }))
            ]
        }
    }
];

/* const pageSections_notch_param_POS = [
    {
        type: 'tableCell',
        targetId: 'attitude-controller-row',
        content: {
            type: 'fieldset',
            style: 'width:580px',
            legend: 'Position Controller Notch Parameters',
            groups: [
                { divId: 'RollNOTCH', style: 'display:block', elements: [
                ]},
                { divId: 'PitchNOTCH', style: 'display:none', elements: [
                ]},
                { divId: 'YawNOTCH', style: 'display:none', elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_NTF', name: 'PSC_ACCZ_NTF', type: 'number', step: '1', value: '0' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'PSC_ACCZ_NEF', name: 'PSC_ACCZ_NEF', type: 'number', step: '1', value: '0' } ] }
                ]},
                ...[...Array(8).keys()].map(i => ({
                    divId: `FILT${i + 1}`, style: 'display:none', elements: [
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_TYPE`, name: `FILT${i + 1}_TYPE`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_FREQ`, name: `FILT${i + 1}_NOTCH_FREQ`, type: 'number', step: '1', value: '0', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_Q`, name: `FILT${i + 1}_NOTCH_Q`, type: 'number', step: '0.1', value: '2', style: 'width: 100px' } ] },
                        { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_ATT`, name: `FILT${i + 1}_NOTCH_ATT`, type: 'number', step: '1', value: '40', style: 'width: 100px' } ] }
                    ]
                }))
            ]
        }
    }
]; */

const pageSections_freq_resp_plots = [
    {
        type: 'heading',
        level: 2,
        content: {
            tag: 'label',
            id: 'PID_title',
            text: 'Calculated vs. Predicted Comparison'
        }
    },
    {
        type: 'plot_divs',
        divs: [
            { id: 'FFTPlotMag', style: 'width:1200px;height:350px' },
            { id: 'FFTPlotPhase', style: 'width:1200px;height:350px' },
            { id: 'FFTPlotCoh', style: 'width:1200px;height:250px' }
        ]
    }
]

const pageSections_freq_resp_plot_options_start = [
    {
        type: 'form',
        id: 'plot_options',
        action: '',
        content: [
        ]
    }
];

const pageSections_freq_resp_plot_options_RW = [
    {
        type: 'form',
        id: 'plot_options',
        isFragment: true,
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'Graph Settings',
                elements: [
                    {
                        tag: 'table',
                        content: [
                            {
                                tag: 'tr',
                                id: 'plot-options-row',
                                content: [
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:400px;height:200px',
                                                legend: 'Control Loop',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'type_Bare_AC', name: 'Control_Loop', value: 'Bare_AC' },
                                                    { tag: 'label', for: 'type_Bare_AC', text: 'Bare Aircraft' },
                                                    { tag: 'input', type: 'checkbox', id: 'UseAttitude', name: 'UseAttitude' },
                                                    { tag: 'label', for: 'UseAttitude', text: 'Use Attitude to Improve Coherence' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Ctrlr', name: 'Control_Loop', value: 'Rate_Ctrlr', checked: true },
                                                    { tag: 'label', for: 'type_Rate_Ctrlr', text: 'Rate Controller' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr', name: 'Control_Loop', value: 'Att_Ctrlr' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr', text: 'Attitude Controller with Feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr_nff', name: 'Control_Loop', value: 'Att_Ctrlr_nff' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr_nff', text: 'Attitude Controller without feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Pilot_Ctrlr', name: 'Control_Loop', value: 'Pilot_Ctrlr' },
                                                    { tag: 'label', for: 'type_Pilot_Ctrlr', text: 'Input Shaping' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_DRB', name: 'Control_Loop', value: 'Att_DRB' },
                                                    { tag: 'label', for: 'type_Att_DRB', text: 'Attitude Disturbance Rejection' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Stab', name: 'Control_Loop', value: 'Rate_Stab' },
                                                    { tag: 'label', for: 'type_Rate_Stab', text: 'Rate Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Stab', name: 'Control_Loop', value: 'Att_Stab' },
                                                    { tag: 'label', for: 'type_Att_Stab', text: 'Attitude Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Sys_Stab', name: 'Control_Loop', value: 'Sys_Stab' },
                                                    { tag: 'label', for: 'type_Sys_Stab', text: 'Entire System Stability' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_freq_resp_plot_options_POS = [
    {
        type: 'form',
        id: 'plot_options',
        isFragment: true,
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'Graph Settings',
                elements: [
                    {
                        tag: 'table',
                        content: [
                            {
                                tag: 'tr',
                                id: 'plot-options-row',
                                content: [
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:400px;height:200px',
                                                legend: 'Control Loop',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'type_Bare_AC', name: 'Control_Loop', value: 'Bare_AC' },
                                                    { tag: 'label', for: 'type_Bare_AC', text: 'Bare Aircraft' },
                                                    { tag: 'input', type: 'checkbox', id: 'UseAttitude', name: 'UseAttitude' },
                                                    { tag: 'label', for: 'UseAttitude', text: 'Use Attitude to Improve Coherence' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Ctrlr', name: 'Control_Loop', value: 'Rate_Ctrlr', checked: true },
                                                    { tag: 'label', for: 'type_Rate_Ctrlr', text: 'Rate Controller' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr', name: 'Control_Loop', value: 'Att_Ctrlr' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr', text: 'Attitude Controller with Feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr_nff', name: 'Control_Loop', value: 'Att_Ctrlr_nff' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr_nff', text: 'Attitude Controller without feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Pilot_Ctrlr', name: 'Control_Loop', value: 'Pilot_Ctrlr' },
                                                    { tag: 'label', for: 'type_Pilot_Ctrlr', text: 'Input Shaping' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_DRB', name: 'Control_Loop', value: 'Att_DRB' },
                                                    { tag: 'label', for: 'type_Att_DRB', text: 'Attitude Disturbance Rejection' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Stab', name: 'Control_Loop', value: 'Rate_Stab' },
                                                    { tag: 'label', for: 'type_Rate_Stab', text: 'Rate Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Stab', name: 'Control_Loop', value: 'Att_Stab' },
                                                    { tag: 'label', for: 'type_Att_Stab', text: 'Attitude Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Sys_Stab', name: 'Control_Loop', value: 'Sys_Stab' },
                                                    { tag: 'label', for: 'type_Sys_Stab', text: 'Entire System Stability' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_freq_resp_plot_options_end = [
    {
        type: 'tableCell',
        targetId: 'plot-options-row',
        content: {
            tag: 'fieldset',
            style: 'width:150px; height:70px',
            legend: 'Gain scale',
            elements: [
                { tag: 'input', type: 'radio', id: 'PID_ScaleLog', name: 'PID_Scale', value: 'Log', checked: true },
                { tag: 'label', for: 'PID_ScaleLog', text: 'dB' },
                { tag: 'br' },
                { tag: 'input', type: 'radio', id: 'PID_ScaleLinear', name: 'PID_Scale', value: 'Linear' },
                { tag: 'label', for: 'PID_ScaleLinear', text: 'Linear' }
            ]
        }
    },
    {
        type: 'tableCell',
        targetId: 'plot-options-row',
        content: {
            tag: 'fieldset',
            style: 'width:150px; height:70px',
            legend: 'Phase scale',
            elements: [
                { tag: 'input', type: 'radio', id: 'PID_ScaleUnWrap', name: 'PID_PhaseScale', value: 'unwrap' },
                { tag: 'label', for: 'PID_ScaleUnWrap', text: 'un-wrapped' },
                { tag: 'br' },
                { tag: 'input', type: 'radio', id: 'PID_ScaleWrap', name: 'PID_PhaseScale', value: 'wrap', checked: true },
                { tag: 'label', for: 'PID_ScaleWrap', text: '180' }
            ]
        }
    },
    {
        type: 'tableCell',
        targetId: 'plot-options-row',
        content: {
            tag: 'fieldset',
            style: 'width:150px; height:70px',
            legend: 'Frequency scale',
            elements: [
                { tag: 'input', type: 'radio', id: 'PID_freq_ScaleLog', name: 'PID_feq_scale', value: 'Log', checked: true },
                { tag: 'label', for: 'PID_freq_ScaleLog', text: 'Log' },
                { tag: 'br' },
                { tag: 'input', type: 'radio', id: 'PID_freq_ScaleLinear', name: 'PID_feq_scale', value: 'Linear' },
                { tag: 'label', for: 'PID_freq_ScaleLinear', text: 'Linear' }
            ]
        }
    },
    {
        type: 'tableCell',
        targetId: 'plot-options-row',
        content: {
            tag: 'fieldset',
            style: 'width:150px; height:70px',
            legend: 'Frequency Units',
            elements: [
                { tag: 'input', type: 'radio', id: 'PID_freq_Scale_Hz', name: 'PID_feq_unit', value: 'Hz', checked: true },
                { tag: 'label', for: 'PID_freq_Scale_Hz', text: 'Hz' },
                { tag: 'br' },
                { tag: 'input', type: 'radio', id: 'PID_freq_Scale_RPS', name: 'PID_feq_unit', value: 'RPS' },
                { tag: 'label', for: 'PID_freq_Scale_RPS', text: 'Rad/s' }
            ]
        }
    }
];


// =====================================================================================
// DYNAMIC PAGE BUILDER FUNCTIONS
// =====================================================================================

function createElement(tag, attributes = {}, children = null) {
    const el = document.createElement(tag);
    for (const key in attributes) {
        if (key.startsWith('data-')) {
            el.setAttribute(key, attributes[key]);
        } else if (key === 'for') {
            el.htmlFor = attributes[key];
        } else if (key === 'text') {
            el.textContent = attributes[key];
        } else {
            el[key] = attributes[key];
        }
    }
    if (children) {
        if (Array.isArray(children)) {
            children.forEach(child => el.appendChild(child));
        } else {
            el.append(children);
        }
    }
    return el;
}

function createFieldset(data) {
    const fieldset = createElement('fieldset', { style: data.style || '', id: data.id || '' });
    if (data.legend) {
        fieldset.appendChild(createElement('legend', {}, data.legend));
    }
    const appendElements = (container, elements) => {
        elements.forEach(elementDef => {
            if (elementDef.type === 'p') {
                const p = createElement('p');
                elementDef.content.forEach(item => {
                    const attrs = { ...item };
                    delete attrs.tag;
                    p.appendChild(createElement(item.tag, attrs));
                });
                container.appendChild(p);
            } else if (elementDef.tag) {
                // **FIX:** Check if the element is complex (has children) or simple.
                if (elementDef.content || elementDef.elements) {
                    // It's a complex element like a table; use the builder function.
                    const complexEl = buildComplexElement(elementDef);
                    container.appendChild(complexEl);
                } else {
                    // It's a simple element like <input> or <label>; create it directly with all attributes.
                    const attrs = { ...elementDef };
                    delete attrs.tag;
                    container.appendChild(createElement(elementDef.tag, attrs));
                }
            }
        });
    };
    if (data.elements) {
        appendElements(fieldset, data.elements);
    }
    if (data.groups) {
        data.groups.forEach(groupDef => {
            const div = createElement('div', { id: groupDef.divId, style: groupDef.style });
            appendElements(div, groupDef.elements);
            fieldset.appendChild(div);
        });
    }
    return fieldset;
}

function buildComplexElement(data) {
    // 1. Prepare attributes, excluding structural properties used for building
    const attrs = { ...data };
    delete attrs.tag;
    delete attrs.type;
    delete attrs.content;
    delete attrs.elements;
    delete attrs.legend;
    delete attrs.groups;

    // 2. Create the element itself (e.g., <table>, <tr>, <td>)
    const el = createElement(data.tag || data.type, attrs);

    // 3. Recursively build children from the 'content' property
    if (data.content) {
        // **THE FIX:** Normalize the 'content' property to always be an array.
        // This handles cases where 'content' is a single object instead of an array of objects.
        const contentArray = Array.isArray(data.content) ? data.content : [data.content];

        contentArray.forEach(childDef => {
            let childEl;
            // Decide which builder function to use for the child element
            if (childDef.type === 'fieldset' || childDef.tag === 'fieldset') {
                // If the child is a fieldset, use the specialized createFieldset function
                childEl = createFieldset(childDef);
            } else {
                // For any other element (like a <tr> or <td>), recurse
                childEl = buildComplexElement(childDef);
            }
            el.appendChild(childEl);
        });
    }

    return el;
}

function buildDynamicContent(sectionsToBuild) {
    const defaultContainer = document.getElementById('dynamic-content-container');

    sectionsToBuild.forEach(section => {
        const parentElement = section.targetId ? document.getElementById(section.targetId) : defaultContainer;
        if (!parentElement) {
            console.error(`Target element with ID "${section.targetId}" not found.`);
            return;
        }

        if (section.type === 'heading') {
            const label = createElement(section.content.tag, { id: section.content.id, textContent: section.content.text });
            const heading = createElement(`h${section.level}`, {}, [label]);
            parentElement.appendChild(heading);
        }
        else if (section.type === 'form') {
            let form = section.isFragment ? document.getElementById(section.id) : createElement('form', { id: section.id, action: section.action || '' });
            if (!form) {
                console.error(`Form with ID "${section.id}" to append to not found.`);
                return;
            }
            section.content.forEach(item => {
                 if (item.type === 'fieldset') {
                    form.appendChild(createFieldset(item));
                 } else if (item.type === 'table') {
                    item.content.forEach(tableContent => {
                        form.appendChild(buildComplexElement(tableContent));
                    });
                 }
            });
            if (!section.isFragment) parentElement.appendChild(form);
        }
        else if (section.type === 'plot_divs') {
            section.divs.forEach(divData => {
                parentElement.appendChild(createElement('div', divData));
            });
        }
        else if (section.type === 'tableCell') {
             if (parentElement.tagName !== 'TR') {
                console.error(`Target for tableCell must be a <tr>, but found a <${parentElement.tagName}>.`);
                return;
             }
             const td = createElement('td');
             td.appendChild(createFieldset(section.content));
             parentElement.appendChild(td);
        }
    });
}


// --- Event Handling and Initialization ---

window.onerror = function(msg, url, linenumber) {
      alert('Sorry, something went wrong.\n\n' + msg);
      return false;
}
window.addEventListener('unhandledrejection', function (e) {
      throw new Error(e.reason.stack);
})

const dynamicContainer = document.getElementById('dynamic-content-container');
if (dynamicContainer) {
    dynamicContainer.addEventListener('change', function(event) {
        const target = event.target;
        const id = target.id;
        if (target.tagName !== 'INPUT') return;

        if (id === 'INS_HNTCH_ENABLE' || id === 'INS_HNTC2_ENABLE') {
            if (typeof update_hidden === 'function') update_hidden(id);
        } else if (id === 'INS_HNTCH_MODE' || id === 'INS_HNTC2_MODE') {
            if (typeof update_hidden_mode === 'function') update_hidden_mode();
        }

        if (target.name === 'Control_Loop' || target.name === 'PID_Scale' || target.name === 'PID_PhaseScale' || target.name === 'PID_feq_scale' || target.name === 'PID_feq_unit') {
             if (typeof redraw_freq_resp === 'function') redraw_freq_resp();
        } else {
             if (typeof calculate_freq_resp === 'function') calculate_freq_resp();
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    var calc_btn = document.getElementById('calculate');
    if (calc_btn) {
        calc_btn.onclick = function() {
            document.getElementById('dynamic-content-container').innerHTML = '';
            buildDynamicContent(pageSections);
            if (get_page_axis() != 'Lateral' && get_page_axis() != 'Longitudinal' && get_page_axis() != 'Vertical') {
                buildDynamicContent(pageSections_param_notch_mode);
            }
            if (get_vehicle_type() === 'ArduPlane_FW') {
                buildDynamicContent(pageSections_param_FW);
                buildDynamicContent(pageSections_notch_param_FW);
            } else if (get_vehicle_type() === 'ArduPlane_VTOL') {
                buildDynamicContent(pageSections_param_QP);
                buildDynamicContent(pageSections_notch_param_QP);
            } else if (get_page_axis() === 'Lateral' || get_page_axis() === 'Longitudinal' || get_page_axis() === 'Vertical') {
                buildDynamicContent(pageSections_param_POS);
            } else {
                buildDynamicContent(pageSections_param_RW);
                buildDynamicContent(pageSections_notch_param_RW);
            }
            buildDynamicContent(pageSections_freq_resp_plots);
            buildDynamicContent(pageSections_freq_resp_plot_options_start);
            if (get_page_axis() === 'Lateral' || get_page_axis() === 'Longitudinal' || get_page_axis() === 'Vertical') {
                buildDynamicContent(pageSections_freq_resp_plot_options_POS);
            } else {
                buildDynamicContent(pageSections_freq_resp_plot_options_RW);
            }
            buildDynamicContent(pageSections_freq_resp_plot_options_end);

            let params = ["SCHED_LOOP_RATE"];
            var inputs = document.getElementsByTagName("input");
            for (param of inputs) {
                if (param.id && (param.id.startsWith("INS_") || param.id.startsWith("PSC") || param.id.startsWith("ATC_") || param.id.startsWith("Q_A_") || param.id.startsWith("RLL_") || param.id.startsWith("PTCH_") || param.id.startsWith("YAW_") || param.id.startsWith("RLL2SRV_") || param.id.startsWith("PTCH2SRV_") || param.id.startsWith("YAW2SRV_") || param.id.startsWith("FILT") || param.id.startsWith("PILOT") || param.id.startsWith("Q_PLT"))) {
                    params.push(param.id);
                }
            }
            console.log("Parameters identified for loading:", params);

            if(typeof load_param_inputs === 'function') load_param_inputs("params.json", params);
            console.log("Parameters loaded.");
            if(typeof load === 'function') load();
            if(typeof update_all_hidden === 'function') update_all_hidden();
            if(typeof setup_freq_response_plots === 'function') setup_freq_response_plots();
            if(typeof setup_FFT_data === 'function') setup_FFT_data();
            if(typeof axis_changed === 'function') axis_changed();
            if(typeof calculate_freq_resp === 'function') calculate_freq_resp();
        }
    }
});

function readFile(e) {
    const file = e.files[0];
    if (file == null) {
        return;
    }
    let reader = new FileReader();
    reader.onload = function (e) {
        if(typeof load_log === 'function') load_log(reader.result);
        document.title = "SysID: " + file.name;
    }
    reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>