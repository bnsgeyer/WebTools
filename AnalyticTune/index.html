<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ArduCopter Analytic Tune Tool</title>
<link rel="icon" href="../images/AP_favicon.png">
<script type="text/javascript" src="AnalyticTune.js"></script>
<script type="text/javascript" src="DiscreteFilter.js"></script>
<script type="text/javascript" src="../Libraries/FileSaver.js"></script>
<script type="text/javascript" src="../Libraries/Array_Math.js"></script>
<script type="text/javascript" src="../Libraries/ParameterMetadata.js"></script>
<script type="text/javascript" src="../Libraries/Param_Helpers.js"></script>
<script type="text/javascript" src="../Libraries/Plotly_helpers.js"></script>
<script type="text/javascript" src="../Libraries/fft.js"></script>
<script type="text/javascript" src="../Libraries/OpenIn.js"></script>
<script type="text/javascript" src="../Libraries/LoadingOverlay.js"></script>
<script type="text/javascript" src="../Libraries/Plotly_helpers.js"></script>
<script type="text/javascript" src="../Libraries/LogHelpers.js"></script>

<script src="../modules/build/floating-ui/dist/umd/popper.min.js"></script>
<script src="../modules/build/tippyjs/dist/tippy-bundle.umd.min.js"></script>
<script src='../modules/plotly.js/dist/plotly.min.js'></script>
<script src='../modules/fft.js/dist/fft.js'></script>
</head>
<table style="width:1200px"><tr><td>
    <a href="https://ardupilot.org"><img src="../images/ArduPilot.png"></a>
</td><td>
    <a href="https://github.com/ArduPilot/WebTools"><img src="../images/github-mark.png" style="width:60px"></a>
    <br>
    <a href="https://github.com/ArduPilot/WebTools"><img src="../images/GitHub_Logo.png" style="width:60px"></a>
</td></tr></table>

<style>
        div.plotly-notifier {
                visibility: hidden;
        }
</style>

<h1><a href="" style="color: #000000; text-decoration:none;">ArduCopter Analytic Tune Tool</a></h1>

<body onload="setup_time_history_plots();">

<table>
        <tr>
        <td style="width: 30px;"></td>
        <td>
        <fieldset style="width:1100px">
                <legend>Setup</legend>
                <table>
                <tr>
                <td>
                        <fieldset style="width:200px;height:80px">
                        <legend>FFT Settings</legend>
                        <table>
                                <td style="width: 125px;">
                                <label for="FFTWindow_size">Window size</label>
                                </td>
                                <td>
                                <input id="FFTWindow_size" name="FFTWindow_size" type="number" min="1" step="1" value="1024" onchange="window_size_inc(event)" style="width:50px"/>
                                </td>
                        </table>
                        </fieldset>
                </td>
                <td>
                <fieldset style="width:200px;height:80px">
                        <legend>Analysis time</legend>
                        <label for="starttime">Start (s)</label>
                        <input id="starttime" type="number" min="0" step="1" value="0" onchange="time_range_changed()" style="width:100px"/><br><br>
                        <label for="endtime">End (s)</label>
                        <input id="endtime" type="number" min="0" step="1" value="0" onchange="time_range_changed()" style="width:100px"/>
                </fieldset>
                </td>
                <td style="width: 10px;"></td>
                <td>
                <input id="fileItem" type="file" accept=".bin" onchange="readFile(this)"><br><br>
                </td>
                </tr>
                </table>
        </fieldset>
        </td>
        </tr>
</table>
<table>
<tr>
        <td style="width: 30px;"></td>
        <td>
                <fieldset style="width:600px; min-height:300px" id="sid_sets">
                    <legend>System ID Runs</legend>
                </fieldset>
        </td>
        </tr>

</table>


<table><tr><td style="width:1200px">
<h2 style="text-align:center">Flight Data</h2>
</td></tr></table>

<div id="FlightData" style="width:1200px;height:450px"></div>

<p>
  <input type="button" id="calculate" value="Calculate">
  <input type="button" id="SaveParams" value="Save Parameters" onclick="save_parameters();">
  <button class="styleClass" onclick="document.getElementById('param_file').click()">Load Parameters</button>
  <input type='file' id="param_file" style="display:none" onchange="load_parameters(this.files[0]);">
</p>

<!-- Container for dynamically generated content -->
<div id="dynamic-content-container"></div>


<script>
// =====================================================================================
// DATA STRUCTURE FOR DYNAMIC PAGE GENERATION
// =====================================================================================
const pageSections = [
    {
        type: 'heading',
        level: 2,
        content: {
            tag: 'label',
            id: 'warning',
            text: 'WARNING - Parameter values are not updated if they changed during the log. If parameters were changed during the flight, be sure to verify the values below.'
        }
    },
    {
        type: 'form',
        id: 'params',
        action: '',
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'INS Settings',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'GyroSampleRate', text: 'Gyro Sample Rate' }, { tag: 'input', id: 'GyroSampleRate', name: 'GyroSampleRate', type: 'number', step: '1', value: '2000', onchange: 'calculate_freq_resp()' } ] },
                    { type: 'p', content: [ { tag: 'input', id: 'INS_GYRO_FILTER', name: 'INS_GYRO_FILTER', type: 'number', step: '0.1', value: '20.0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] }
                ]
            },
            {
                type: 'table',
                content: [
                    {
                        type: 'fieldset',
                        style: 'width:580px',
                        legend: 'First Notch Filter',
                        elements: [
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_ENABLE', name: 'INS_HNTCH_ENABLE', type: 'number', step: '1', value: '1', style: 'width: 100px', onchange: 'update_hidden(this.id); calculate_freq_resp();' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_MODE', name: 'INS_HNTCH_MODE', type: 'number', step: '1', value: '1', style: 'width: 100px', onchange: 'update_hidden_mode(); calculate_freq_resp();' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_FREQ', name: 'INS_HNTCH_FREQ', type: 'number', step: '0.1', value: '150', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_BW', name: 'INS_HNTCH_BW', type: 'number', step: '0.1', value: '75', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_ATT', name: 'INS_HNTCH_ATT', type: 'number', step: '0.1', value: '40', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_REF', name: 'INS_HNTCH_REF', type: 'number', step: '0.01', value: '0.29', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_FM_RAT', name: 'INS_HNTCH_FM_RAT', type: 'number', step: '0.01', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_HMNCS', name: 'INS_HNTCH_HMNCS', type: 'number', step: '1', value: '3', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTCH_OPTS', name: 'INS_HNTCH_OPTS', type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] }
                        ]
                    },
                    {
                        type: 'fieldset',
                        style: 'width:580px',
                        legend: 'Second Notch Filter',
                        elements: [
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_ENABLE', name: 'INS_HNTC2_ENABLE', type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'update_hidden(this.id); calculate_freq_resp();' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_MODE', name: 'INS_HNTC2_MODE', type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'update_hidden_mode(); calculate_freq_resp();' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_FREQ', name: 'INS_HNTC2_FREQ', type: 'number', step: '0.1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_BW', name: 'INS_HNTC2_BW', type: 'number', step: '0.1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_ATT', name: 'INS_HNTC2_ATT', type: 'number', step: '0.1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_REF', name: 'INS_HNTC2_REF', type: 'number', step: '0.01', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_FM_RAT', name: 'INS_HNTC2_FM_RAT', type: 'number', step: '0.01', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_HMNCS', name: 'INS_HNTC2_HMNCS', type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                            { type: 'p', content: [ { tag: 'input', id: 'INS_HNTC2_OPTS', name: 'INS_HNTC2_OPTS', type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] }
                        ]
                    }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'Loop Rate',
                elements: [
                    { type: 'p', content: [ { tag: 'input', id: 'SCHED_LOOP_RATE', name: 'SCHED_LOOP_RATE', type: 'number', step: '1', value: '400', 'data-paramValues': 'false', onchange: 'calculate_freq_resp()' } ] }
                ]
            }
        ]
    }
];


const pageSections_param = [
    {
        type: 'form',
        id: 'params',
        action: '',
        content: [
            {
                type: 'table',
                content: [
                    {
                        tag: 'tr',
                        content: [
                            {
                                tag: 'td',
                                content: [
                                    {
                                        type: 'fieldset',
                                        style: 'width:580px',
                                        legend: 'Attitude Controller Parameters',
                                        groups: [
                                            { divId: 'RollPitchTC', style: 'display:block', elements: [ { type: 'p', content: [ { tag: 'input', id: 'ATC_INPUT_TC', name: 'ATC_INPUT_TC', type: 'number', step: '0.01', value: '0.15', onchange: 'calculate_freq_resp()' } ] } ] },
                                            { divId: 'QRollPitchTC', style: 'display:none', elements: [ { type: 'p', content: [ { tag: 'input', id: 'Q_A_INPUT_TC', name: 'Q_A_INPUT_TC', type: 'number', step: '0.01', value: '0.15', onchange: 'calculate_freq_resp()' } ] } ] },
                                            { divId: 'YawTC', style: 'display:None', elements: [ { type: 'p', content: [ { tag: 'input', id: 'PILOT_Y_RATE_TC', name: 'PILOT_Y_RATE_TC', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] } ] },
                                            { divId: 'QYawTC', style: 'display:None', elements: [ { type: 'p', content: [ { tag: 'input', id: 'Q_PLT_Y_RATE_TC', name: 'Q_PLT_Y_RATE_TC', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] } ] },
                                            { divId: 'RollPIDS', style: 'display:block', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_RLL_P', name: 'ATC_ANG_RLL_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FF', name: 'ATC_RAT_RLL_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_P', name: 'ATC_RAT_RLL_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_I', name: 'ATC_RAT_RLL_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_D', name: 'ATC_RAT_RLL_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_D_FF', name: 'ATC_RAT_RLL_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTT', name: 'ATC_RAT_RLL_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTE', name: 'ATC_RAT_RLL_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_FLTD', name: 'ATC_RAT_RLL_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'QRollPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_RLL_P', name: 'Q_A_ANG_RLL_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FF', name: 'Q_A_RAT_RLL_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_P', name: 'Q_A_RAT_RLL_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_I', name: 'Q_A_RAT_RLL_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_D', name: 'Q_A_RAT_RLL_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_D_FF', name: 'Q_A_RAT_RLL_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTT', name: 'Q_A_RAT_RLL_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTE', name: 'Q_A_RAT_RLL_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_FLTD', name: 'Q_A_RAT_RLL_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'FWRollPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL2SRV_TCONST', name: 'RLL2SRV_TCONST', type: 'number', step: '0.01', value: '0.25', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FF', name: 'RLL_RATE_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_P', name: 'RLL_RATE_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_I', name: 'RLL_RATE_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_D', name: 'RLL_RATE_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_D_FF', name: 'RLL_RATE_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTT', name: 'RLL_RATE_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTE', name: 'RLL_RATE_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_FLTD', name: 'RLL_RATE_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'PitchPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_PIT_P', name: 'ATC_ANG_PIT_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FF', name: 'ATC_RAT_PIT_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_P', name: 'ATC_RAT_PIT_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_I', name: 'ATC_RAT_PIT_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_D', name: 'ATC_RAT_PIT_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_D_FF', name: 'ATC_RAT_PIT_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTT', name: 'ATC_RAT_PIT_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTE', name: 'ATC_RAT_PIT_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_FLTD', name: 'ATC_RAT_PIT_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'QPitchPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_PIT_P', name: 'Q_A_ANG_PIT_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FF', name: 'Q_A_RAT_PIT_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_P', name: 'Q_A_RAT_PIT_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_I', name: 'Q_A_RAT_PIT_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_D', name: 'Q_A_RAT_PIT_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_D_FF', name: 'Q_A_RAT_PIT_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTT', name: 'Q_A_RAT_PIT_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTE', name: 'Q_A_RAT_PIT_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_FLTD', name: 'Q_A_RAT_PIT_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'FWPitchPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH2SRV_TCONST', name: 'PTCH2SRV_TCONST', type: 'number', step: '0.01', value: '0.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FF', name: 'PTCH_RATE_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_P', name: 'PTCH_RATE_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_I', name: 'PTCH_RATE_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_D', name: 'PTCH_RATE_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_D_FF', name: 'PTCH_RATE_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTT', name: 'PTCH_RATE_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTE', name: 'PTCH_RATE_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_FLTD', name: 'PTCH_RATE_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'YawPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_ANG_YAW_P', name: 'ATC_ANG_YAW_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FF', name: 'ATC_RAT_YAW_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_P', name: 'ATC_RAT_YAW_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_I', name: 'ATC_RAT_YAW_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_D', name: 'ATC_RAT_YAW_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_D_FF', name: 'ATC_RAT_YAW_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTT', name: 'ATC_RAT_YAW_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTE', name: 'ATC_RAT_YAW_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_FLTD', name: 'ATC_RAT_YAW_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]},
                                            { divId: 'QYawPIDS', style: 'display:none', elements: [
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_ANG_YAW_P', name: 'Q_A_ANG_YAW_P', type: 'number', step: '0.1', value: '4.5', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FF', name: 'Q_A_RAT_YAW_FF', type: 'number', step: '0.01', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_P', name: 'Q_A_RAT_YAW_P', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_I', name: 'Q_A_RAT_YAW_I', type: 'number', step: '0.01', value: '0.288', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_D', name: 'Q_A_RAT_YAW_D', type: 'number', step: '0.0001', value: '0.0117', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_D_FF', name: 'Q_A_RAT_YAW_D_FF', type: 'number', step: '0.0001', value: '0.0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTT', name: 'Q_A_RAT_YAW_FLTT', type: 'number', step: '0.01', value: '1.77', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTE', name: 'Q_A_RAT_YAW_FLTE', type: 'number', step: '0.01', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                                { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_FLTD', name: 'Q_A_RAT_YAW_FLTD', type: 'number', step: '0.01', value: '20', onchange: 'calculate_freq_resp()' } ] }
                                            ]}
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

const pageSections_notch_param = [
    {
        type: 'form',
        id: 'params',
        action: '',
        content: [
            {
                type: 'table',
                content: [
                    {
                        tag: 'td',
                        content: [
                            {
                                type: 'fieldset',
                                style: 'width:580px',
                                legend: 'Attitude Controller Notch Parameters',
                                groups: [
                                    { divId: 'RollNOTCH', style: 'display:block', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_NTF', name: 'ATC_RAT_RLL_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_RLL_NEF', name: 'ATC_RAT_RLL_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'QRollNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_NTF', name: 'Q_A_RAT_RLL_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_RLL_NEF', name: 'Q_A_RAT_RLL_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'FWRollNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_NTF', name: 'RLL_RATE_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'RLL_RATE_NEF', name: 'RLL_RATE_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'PitchNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_NTF', name: 'ATC_RAT_PIT_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_PIT_NEF', name: 'ATC_RAT_PIT_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'QPitchNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_NTF', name: 'Q_A_RAT_PIT_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_PIT_NEF', name: 'Q_A_RAT_PIT_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'FWPitchNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_NTF', name: 'PTCH_RATE_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'PTCH_RATE_NEF', name: 'PTCH_RATE_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'YawNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_NTF', name: 'ATC_RAT_YAW_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'ATC_RAT_YAW_NEF', name: 'ATC_RAT_YAW_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'QYawNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_NTF', name: 'Q_A_RAT_YAW_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'Q_A_RAT_YAW_NEF', name: 'Q_A_RAT_YAW_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    { divId: 'FWYawNOTCH', style: 'display:none', elements: [
                                        { type: 'p', content: [ { tag: 'input', id: 'YAW_RATE_NTF', name: 'YAW_RATE_NTF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] },
                                        { type: 'p', content: [ { tag: 'input', id: 'YAW_RATE_NEF', name: 'YAW_RATE_NEF', type: 'number', step: '1', value: '0', onchange: 'calculate_freq_resp()' } ] }
                                    ]},
                                    ...[...Array(8).keys()].map(i => ({
                                        divId: `FILT${i + 1}`, style: 'display:none', elements: [
                                            { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_TYPE`, name: `FILT${i + 1}_TYPE`, type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_FREQ`, name: `FILT${i + 1}_NOTCH_FREQ`, type: 'number', step: '1', value: '0', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_Q`, name: `FILT${i + 1}_NOTCH_Q`, type: 'number', step: '0.1', value: '2', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] },
                                            { type: 'p', content: [ { tag: 'input', id: `FILT${i + 1}_NOTCH_ATT`, name: `FILT${i + 1}_NOTCH_ATT`, type: 'number', step: '1', value: '40', style: 'width: 100px', onchange: 'calculate_freq_resp()' } ] }
                                        ]
                                    }))
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'Throttle_input',
                legend: 'Throttle Based',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'Throttle', text: 'Throttle' }, { tag: 'input', id: 'Throttle', name: 'Throttle', type: 'number', step: '0.01', value: '0.3' } ] }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'ESC_input',
                legend: 'ESC Telemetry',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'NUM_MOTORS', text: 'Number of Motors' }, { tag: 'input', id: 'NUM_MOTORS', name: 'NUM_MOTORS', type: 'number', step: '1', value: '1' } ] },
                    { type: 'p', content: [ { tag: 'label', for: 'ESC_RPM', text: 'ESC RPM' }, { tag: 'input', id: 'ESC_RPM', name: 'ESC_RPM', type: 'number', step: '1', value: '2500' } ] }
                ]
            },
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                id: 'RPM_input',
                legend: 'RPM/EFI Based',
                elements: [
                    { type: 'p', content: [ { tag: 'label', for: 'RPM1', text: 'RPM1' }, { tag: 'input', id: 'RPM1', name: 'RPM1', type: 'number', step: '1', value: '2500' } ] },
                    { type: 'p', content: [ { tag: 'label', for: 'RPM2', text: 'RPM2' }, { tag: 'input', id: 'RPM2', name: 'RPM2', type: 'number', step: '1', value: '2500' } ] }
                ]
            }
        ]
    }
];


const pageSections_freq_resp_plots = [
    {
        type: 'heading',
        level: 2,
        content: {
            tag: 'label',
            id: 'PID_title',
            text: 'Calculated vs. Predicted Comparison'
        }
    },
    {
        type: 'plot_divs',
        divs: [
            { id: 'FFTPlotMag', style: 'width:1200px;height:350px' },
            { id: 'FFTPlotPhase', style: 'width:1200px;height:350px' },
            { id: 'FFTPlotCoh', style: 'width:1200px;height:250px' }
        ]
    },
    {
        type: 'form',
        id: 'plot_options',
        action: '',
        content: [
            {
                type: 'fieldset',
                style: 'max-width:1200px',
                legend: 'Graph Settings',
                // The complex table structure is now a direct element.
                // This allows the `buildComplexElement` function to be correctly triggered.
                elements: [
                    {
                        tag: 'table',
                        content: [
                            {
                                tag: 'tr',
                                content: [
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:400px;height:200px',
                                                legend: 'Control Loop',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'type_Bare_AC', name: 'Control_Loop', value: 'Bare_AC', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Bare_AC', text: 'Bare Aircraft' },
                                                    { tag: 'input', type: 'checkbox', id: 'UseAttitude', name: 'UseAttitude', onclick: 'calculate_freq_resp();' },
                                                    { tag: 'label', for: 'UseAttitude', text: 'Use Attitude to Improve Coherence' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Ctrlr', name: 'Control_Loop', value: 'Rate_Ctrlr', onchange: 'redraw_freq_resp();', checked: true },
                                                    { tag: 'label', for: 'type_Rate_Ctrlr', text: 'Rate Controller' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr', name: 'Control_Loop', value: 'Att_Ctrlr', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr', text: 'Attitude Controller with Feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Ctrlr_nff', name: 'Control_Loop', value: 'Att_Ctrlr_nff', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Att_Ctrlr_nff', text: 'Attitude Controller without feedforward' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Pilot_Ctrlr', name: 'Control_Loop', value: 'Pilot_Ctrlr', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Pilot_Ctrlr', text: 'Input Shaping' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_DRB', name: 'Control_Loop', value: 'Att_DRB', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Att_DRB', text: 'Attitude Disturbance Rejection' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Rate_Stab', name: 'Control_Loop', value: 'Rate_Stab', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Rate_Stab', text: 'Rate Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Att_Stab', name: 'Control_Loop', value: 'Att_Stab', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Att_Stab', text: 'Attitude Stability' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'type_Sys_Stab', name: 'Control_Loop', value: 'Sys_Stab', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'type_Sys_Stab', text: 'Entire System Stability' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:150px; height:70px',
                                                legend: 'Gain scale',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'PID_ScaleLog', name: 'PID_Scale', value: 'Log', onchange: 'redraw_freq_resp();', checked: true },
                                                    { tag: 'label', for: 'PID_ScaleLog', text: 'dB' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'PID_ScaleLinear', name: 'PID_Scale', value: 'Linear', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'PID_ScaleLinear', text: 'Linear' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:150px; height:70px',
                                                legend: 'Phase scale',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'PID_ScaleUnWrap', name: 'PID_PhaseScale', value: 'unwrap', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'PID_ScaleUnWrap', text: 'un-wrapped' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'PID_ScaleWrap', name: 'PID_PhaseScale', value: 'wrap', onchange: 'redraw_freq_resp();', checked: true },
                                                    { tag: 'label', for: 'PID_ScaleWrap', text: 'Â±180' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:150px; height:70px',
                                                legend: 'Frequency scale',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'PID_freq_ScaleLog', name: 'PID_feq_scale', value: 'Log', onchange: 'redraw_freq_resp();', checked: true },
                                                    { tag: 'label', for: 'PID_freq_ScaleLog', text: 'Log' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'PID_freq_ScaleLinear', name: 'PID_feq_scale', value: 'Linear', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'PID_freq_ScaleLinear', text: 'Linear' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        tag: 'td',
                                        content: [
                                            {
                                                tag: 'fieldset',
                                                style: 'width:150px; height:70px',
                                                legend: 'Frequency Units',
                                                elements: [
                                                    { tag: 'input', type: 'radio', id: 'PID_freq_Scale_Hz', name: 'PID_feq_unit', value: 'Hz', onchange: 'redraw_freq_resp();', checked: true },
                                                    { tag: 'label', for: 'PID_freq_Scale_Hz', text: 'Hz' },
                                                    { tag: 'br' },
                                                    { tag: 'input', type: 'radio', id: 'PID_freq_Scale_RPS', name: 'PID_feq_unit', value: 'RPS', onchange: 'redraw_freq_resp();' },
                                                    { tag: 'label', for: 'PID_freq_Scale_RPS', text: 'Rad/s' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
];

// =====================================================================================
// DYNAMIC PAGE BUILDER FUNCTIONS
// =====================================================================================

/**
 * Creates and returns a DOM element with specified attributes.
 * @param {string} tag - The HTML tag name.
 * @param {object} attributes - An object of attributes to set.
 * @param {string|Node|Array<Node>} [children] - Child content.
 * @returns {HTMLElement} The created DOM element.
 */
function createElement(tag, attributes = {}, children = null) {
    const el = document.createElement(tag);
    for (const key in attributes) {
        if (key.startsWith('data-')) {
            el.setAttribute(key, attributes[key]);
        } else if (key === 'for') {
            el.htmlFor = attributes[key];
        } else if (key === 'text') {
            el.textContent = attributes[key];
        } else {
            el[key] = attributes[key];
        }
    }
    if (children) {
        if (Array.isArray(children)) {
            children.forEach(child => el.appendChild(child));
        } else {
            el.append(children);
        }
    }
    return el;
}

/**
 * Creates a complete fieldset element from a data object.
 * @param {object} data - The fieldset definition.
 * @returns {HTMLFieldSetElement} The created fieldset element.
 */
function createFieldset(data) {
    const fieldset = createElement('fieldset', { style: data.style || '', id: data.id || '' });
    if (data.legend) {
        fieldset.appendChild(createElement('legend', {}, data.legend));
    }

    const appendElements = (container, elements) => {
        elements.forEach(elementDef => {
            if (elementDef.type === 'p') {
                const p = createElement('p');
                elementDef.content.forEach(item => {
                    const attrs = { ...item };
                    delete attrs.tag;
                    p.appendChild(createElement(item.tag, attrs));
                });
                container.appendChild(p);
            } else if (elementDef.tag) { // Handle complex fieldsets like Graph Settings
                 const complexEl = buildComplexElement(elementDef);
                 container.appendChild(complexEl);
            }
        });
    };

    if (data.elements) {
        appendElements(fieldset, data.elements);
    }
    if (data.groups) {
        data.groups.forEach(groupDef => {
            const div = createElement('div', { id: groupDef.divId, style: groupDef.style });
            appendElements(div, groupDef.elements);
            fieldset.appendChild(div);
        });
    }
    return fieldset;
}

/**
 * Recursively builds complex, nested elements like tables.
 * @param {object} data - The element definition.
 * @returns {HTMLElement} The created element.
 */
function buildComplexElement(data) {
    const attrs = { ...data };
    delete attrs.tag;
    delete attrs.content;
    delete attrs.elements;
    delete attrs.legend;

    const el = createElement(data.tag, attrs);

    if (data.legend) { // For nested fieldsets
        el.appendChild(createElement('legend', {}, data.legend));
    }

    if (data.content) {
        data.content.forEach(childData => {
            el.appendChild(buildComplexElement(childData));
        });
    }

    if (data.elements) { // For elements inside fieldsets
         data.elements.forEach(item => {
            const itemAttrs = { ...item };
            delete itemAttrs.tag;
            el.appendChild(createElement(item.tag, itemAttrs));
         });
    }
    return el;
}


/**
 * Main function to build all dynamic content on the page.
 */
function buildDynamicContent() {
    const container = document.getElementById('dynamic-content-container');
    if (!container) {
        console.error('Dynamic content container not found!');
        return;
    }

    pageSections.forEach(section => {
        if (section.type === 'heading') {
            const label = createElement(section.content.tag, { id: section.content.id, textContent: section.content.text });
            const heading = createElement(`h${section.level}`, {}, [label]);
            container.appendChild(heading);
        }
        else if (section.type === 'form') {
            const form = createElement('form', { id: section.id, action: section.action || '' });
            section.content.forEach(item => {
                 if (item.type === 'fieldset') {
                    form.appendChild(createFieldset(item));
                 } else if (item.type === 'table') {
                    const table = createElement('table');
                    const tr = createElement('tr');
                    item.content.forEach(cellData => {
                        const td = createElement('td');
                        td.appendChild(createFieldset(cellData));
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                    form.appendChild(table);
                 }
            });
            container.appendChild(form);
        }
        else if (section.type === 'plot_divs') {
            section.divs.forEach(divData => {
                container.appendChild(createElement('div', divData));
            });
        }
    });

    pageSections_param.forEach(section => {
        if (section.type === 'heading') {
            const label = createElement(section.content.tag, { id: section.content.id, textContent: section.content.text });
            const heading = createElement(`h${section.level}`, {}, [label]);
            container.appendChild(heading);
        }
        else if (section.type === 'form') {
            const form = createElement('form', { id: section.id, action: section.action || '' });
            section.content.forEach(item => {
                 if (item.type === 'fieldset') {
                    form.appendChild(createFieldset(item));
                 } else if (item.type === 'table') {
                    const table = createElement('table');
                    const tr = createElement('tr');
                    item.content.forEach(cellData => {
                        const td = createElement('td');
                        td.appendChild(createFieldset(cellData));
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                    form.appendChild(table);
                 }
            });
            container.appendChild(form);
        }
        else if (section.type === 'plot_divs') {
            section.divs.forEach(divData => {
                container.appendChild(createElement('div', divData));
            });
        }
    });

    pageSections_notch_param.forEach(section => {
        if (section.type === 'heading') {
            const label = createElement(section.content.tag, { id: section.content.id, textContent: section.content.text });
            const heading = createElement(`h${section.level}`, {}, [label]);
            container.appendChild(heading);
        }
        else if (section.type === 'form') {
            const form = createElement('form', { id: section.id, action: section.action || '' });
            section.content.forEach(item => {
                 if (item.type === 'fieldset') {
                    form.appendChild(createFieldset(item));
                 } else if (item.type === 'table') {
                    const table = createElement('table');
                    const tr = createElement('tr');
                    item.content.forEach(cellData => {
                        const td = createElement('td');
                        td.appendChild(createFieldset(cellData));
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                    form.appendChild(table);
                 }
            });
            container.appendChild(form);
        }
        else if (section.type === 'plot_divs') {
            section.divs.forEach(divData => {
                container.appendChild(createElement('div', divData));
            });
        }
    });

    pageSections_freq_resp_plots.forEach(section => {
        if (section.type === 'heading') {
            const label = createElement(section.content.tag, { id: section.content.id, textContent: section.content.text });
            const heading = createElement(`h${section.level}`, {}, [label]);
            container.appendChild(heading);
        }
        else if (section.type === 'form') {
            const form = createElement('form', { id: section.id, action: section.action || '' });
            section.content.forEach(item => {
                 if (item.type === 'fieldset') {
                    form.appendChild(createFieldset(item));
                 } else if (item.type === 'table') {
                    const table = createElement('table');
                    const tr = createElement('tr');
                    item.content.forEach(cellData => {
                        const td = createElement('td');
                        td.appendChild(createFieldset(cellData));
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                    form.appendChild(table);
                 }
            });
            container.appendChild(form);
        }
        else if (section.type === 'plot_divs') {
            section.divs.forEach(divData => {
                container.appendChild(createElement('div', divData));
            });
        }
    });

}


// --- Original Script Content ---

  window.onerror = function(msg, url, linenumber) {
      alert('Sorry, something went wrong.\n\n' +
            'Please try a hard reload of this page to clear its cache.\n\n' +
            'If the error persists open an issue on the GitHub repo.\n' +
            'Include a copy of the log and the following error message:\n\n' +
             msg + '\n' +
            'URL: '+ url +'\n' +
            'Line Number: '+ linenumber)
      return false
  }
  window.addEventListener('unhandledrejection', function (e) {
        throw new Error(e.reason.stack)
  })

// Attach one master listener to the static parent container.
const dynamicContainer = document.getElementById('dynamic-content-container');
if (dynamicContainer) {
    dynamicContainer.addEventListener('change', function(event) {
        const target = event.target;
        const id = target.id;

        // Check if the element that changed is an input or a radio button we care about
        if (target.tagName === 'INPUT') {
            // --- Special Handlers ---
            if (id === 'INS_HNTCH_ENABLE' || id === 'INS_HNTC2_ENABLE') {
                if (typeof update_hidden === 'function') update_hidden(id);
                if (typeof calculate_freq_resp === 'function') calculate_freq_resp();
            }
            else if (id === 'INS_HNTCH_MODE' || id === 'INS_HNTC2_MODE') {
                if (typeof update_hidden_mode === 'function') update_hidden_mode();
                if (typeof calculate_freq_resp === 'function') calculate_freq_resp();
            }
            // --- Handlers for Graph Settings Radio Buttons ---
            else if (target.name === 'Control_Loop' || target.name === 'PID_Scale' || target.name === 'PID_PhaseScale' || target.name === 'PID_feq_scale' || target.name === 'PID_feq_unit') {
                 if (typeof redraw_freq_resp === 'function') redraw_freq_resp();
            }
            // --- Default Handler for most other parameter inputs ---
            else {
                 if (typeof calculate_freq_resp === 'function') calculate_freq_resp();
            }
        }
    });
}

  // We must wait until the dynamic content is created to attach the event listener
  document.addEventListener('DOMContentLoaded', () => {
    // Re-select the calculate button after it's been created
    var calc_btn = document.getElementById('calculate');
    if (calc_btn) {
        calc_btn.onclick = function() {
            buildDynamicContent();
            let params = ["SCHED_LOOP_RATE", "PILOT_Y_RATE_TC", "Q_PLT_Y_RATE_TC"]
            var inputs = document.getElementsByTagName("input");
            for (param of inputs) {
                if (param.id.startsWith("INS_") || param.id.startsWith("ATC_") || param.id.startsWith("Q_A_") || param.id.startsWith("RLL_") || param.id.startsWith("PTCH_") || param.id.startsWith("YAW_") || param.id.startsWith("RLL2SRV_") || param.id.startsWith("PTCH2SRV_") || param.id.startsWith("YAW2SRV_") || param.id.startsWith("FILT")) {
                    params.push(param.id)
                }
            }
            console.log(params)
            load_param_inputs("params.json", params)
            load();
            update_all_hidden();
            setup_freq_response_plots();
            setup_FFT_data();
            axis_changed();
            calculate_freq_resp();
        }
    }
  });

// Handler for file select
function readFile(e) {
        const file = e.files[0]
        if (file == null) {
                return
        }
        let reader = new FileReader()
        reader.onload = function (e) {
                load_log(reader.result)
                document.title = "SysID: " + file.name
        }
        reader.readAsArrayBuffer(file)
}
</script>

</body>
</html>